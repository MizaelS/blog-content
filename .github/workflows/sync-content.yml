name: Sync Content to Teramont Website

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  sync:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
    
      - name: Verificar variable GH_TOKEN
        run: echo "GH_TOKEN starts with: ${GH_TOKEN:0:4}..."
        env:
        GH_TOKEN: ${{ secrets.TERAMONT_PAT }}
        
      - name: Checkout Teramont website repo
        uses: actions/checkout@v3
        with:
          repository: Teramont-Host/new-website
          path: teramont-web
          token: ${{ secrets.TERAMONT_PAT }}
          persist-credentials: true
          fetch-depth: 0

      - name: Debug token presence
        run: |
          if [ -n "${{ secrets.TERAMONT_PAT }}" ]; then
            echo "Token está presente"
          else
            echo "Token no está disponible"
            exit 1
          fi

      - name: Sync blog content
        env:
          GH_TOKEN: ${{ secrets.TERAMONT_PAT }}
        run: |
          # Eliminar contenido existente
          rm -rf teramont-web/content/*
          
          # Copiar nuevo contenido
          cp -r content/* teramont-web/content/
          
          # Configurar git
          cd teramont-web
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit y push de cambios
          git add .
          git commit -m "sync: Actualización de contenido desde blog-content-repo - PR #${{ github.event.pull_request.number }}"
          git push origin HEAD:main